name: StalinGame

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [armeabi-v7a, arm64-v8a]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip make build-essential \
            gcc g++ clang binutils \
            openjdk-11-jdk \
            autoconf automake autoconf-archive libtool pkg-config \
            libltdl-dev cmake \
            python3-pip python3-setuptools python3-dev \
            cython3 \
            zlib1g-dev libssl-dev libffi-dev \
            libncurses5-dev libncursesw5-dev libtinfo-dev \
            libbz2-dev libexpat1-dev libreadline-dev libsqlite3-dev \
            libgdbm-dev libgdbm-compat-dev liblzma-dev

      - name: Install Buildozer and pinned Cython
        run: |
          python3 -m pip install --upgrade pip
          pip install --upgrade buildozer
          pip install --upgrade cython==0.29.36

      - name: Clean previous builds (force fresh)
        run: |
          rm -rf ./.buildozer/android/platform/build-* || true
          rm -rf ./.buildozer/android/platform/python-for-android || true
          rm -rf ./.buildozer/android/platform/buildozer || true

      ############################################
      #  local-recipes/pyjnius (safe, via heredoc)
      ############################################
      - name: Create local PyJNIus recipe and patches
        run: |
          mkdir -p local-recipes/pyjnius/patches

          cat << 'PY' > local-recipes/pyjnius/recipe.py
          from pythonforandroid.recipes.pyjnius import PyjniusRecipe as BaseRecipe
          
          class PyjniusFixedRecipe(BaseRecipe):
              def prebuild_arch(self, arch):
                  print(">>> Applying PyJNIus patches...")
                  self.apply_patch("patches/fix_long.patch")
                  self.apply_patch("patches/fix_jsize.patch")
                  super().prebuild_arch(arch)
          
          recipe = PyjniusFixedRecipe()
          PY
          
                    cat << 'PATCH' > local-recipes/pyjnius/patches/fix_long.patch
          *** Begin Patch
          *** Update File: jnius/jnius_utils.pxi
          @@
          -        if r == 'S' or r == 'I':
          -            if isinstance(arg, int) or (
          -                    (isinstance(arg, long) and arg < 2147483648)):
          +        if r == 'S' or r == 'I':
          +            # Python3: no long type
          +            if isinstance(arg, int) and arg < 2147483648:
                           score += 10
                           continue
          *** End Patch
          PATCH
          
                    cat << 'PATCH' > local-recipes/pyjnius/patches/fix_jsize.patch
          *** Begin Patch
          *** Update File: jnius/jnius_conversion.pxi
          @@
          -    j_strlen = len(py_bytes) / sizeof(jchar) - 1
          +    # integer division, converting to jsize
          +    j_strlen = <jsize>(len(py_bytes) // sizeof(jchar) - 1)
          *** End Patch
          PATCH

      ############################################
      #  Trigger p4a download (makes pyjnius sources appear), then patch if needed
      ############################################
      - name: Trigger p4a download and patch PyJNIus if present
        run: |
          set -euxo pipefail
          # Run a lightweight p4a call to make p4a download recipes (may print warnings)
          buildozer android p4a -- --version || true

          # Find any downloaded jnius files and patch them in-place (if present)
          PYJ_FILE=$(find .buildozer -type f -name "jnius_utils.pxi" | head -n1 || true)
          echo "Found jnius_utils.pxi: '${PYJ_FILE:-<none>}'"

          if [ -n "$PYJ_FILE" ]; then
            PYJ_DIR=$(dirname "$PYJ_FILE")
            echo "Patching pyjnius in: $PYJ_DIR"

            cp -v "$PYJ_DIR/jnius_utils.pxi" "$PYJ_DIR/jnius_utils.pxi.bak" || true
            cp -v "$PYJ_DIR/jnius_conversion.pxi" "$PYJ_DIR/jnius_conversion.pxi.bak" || true

            sed -i 's/isinstance(arg, long)/isinstance(arg, int)/g' "$PYJ_DIR/jnius_utils.pxi" || true
            sed -i 's/len(py_bytes) \/ sizeof(jchar) - 1/<int>(len(py_bytes) \/ sizeof(jchar) - 1)/g' "$PYJ_DIR/jnius_conversion.pxi" || true

            echo "Patched (in-place) pyjnius sources:"
            head -n 5 "$PYJ_DIR/jnius_utils.pxi" || true
            head -n 5 "$PYJ_DIR/jnius_conversion.pxi" || true
          else
            echo "PyJNIus sources not yet downloaded — local-recipes will be used when p4a downloads them."
          fi

      ############################################
      #  SDL shim creation (create libSDL.so in any libs dirs and project ./libs)
      ############################################
      - name: Ensure Android libSDL shim (arch-aware, retry)
        run: |
          set -euxo pipefail

          # NDK clang path that buildozer/p4a uses
          NDK_CLANG="${HOME}/.buildozer/android/platform/android-ndk-r25b/toolchains/llvm/prebuilt/linux-x86_64/bin/clang"
          if [ ! -x "$NDK_CLANG" ]; then
            echo "NDK clang not found at $NDK_CLANG — listing .buildozer for debug"
            ls -la ./.buildozer || true
          fi

          # Determine target triple from P4A_ARCH
          case "${P4A_ARCH:-arm64-v8a}" in
            arm64-v8a) TARGET="aarch64-linux-android21";;
            armeabi-v7a) TARGET="armv7a-linux-androideabi21";;
            *) TARGET="aarch64-linux-android21";;
          esac
          echo "P4A_ARCH=${P4A_ARCH:-arm64-v8a} -> TARGET=$TARGET"

          # candidate directories where linker will search for libSDL
          candidates=()
          # common p4a bootstrap sdl2 obj path
          while IFS= read -r -d '' d; do candidates+=("$d"); done < <(find .buildozer -type d -path "*/build/bootstrap_builds/sdl2/obj/local/*" -print0 || true)
          # any libs directories under .buildozer
          while IFS= read -r -d '' d; do candidates+=("$d"); done < <(find .buildozer -type d -name "libs" -print0 || true)
          # fallback project ./libs
          candidates+=( "./libs" )

          # wait for p4a to create bootstrap directories (up to ~60s)
          found=""
          for i in $(seq 1 12); do
            for c in "${candidates[@]}"; do
              if [ -d "$c" ]; then
                # prefer a path that contains the arch part if present
                if [[ "$c" == *"${P4A_ARCH:-arm64-v8a}"* ]] || [[ "$c" == "./libs" ]]; then
                  found="$c"
                  break 2
                fi
              fi
            done
            echo "Waiting for bootstrap libs folder to appear... attempt $i/12"
            sleep 5
          done

          if [ -z "$found" ]; then
            # if still not found, pick first candidate that exists or create ./libs
            for c in "${candidates[@]}"; do
              if [ -d "$c" ]; then found="$c"; break; fi
            done
            if [ -z "$found" ]; then
              mkdir -p ./libs
              found="./libs"
            fi
          fi

          echo "Using shim destination: $found"

          # C source for shim (one file used to create both .so names)
          SHIM_C="$(mktemp -t sdl_shim_XXXX.c)"
          cat > "$SHIM_C" <<'C'
          /* minimal dummy symbols so linker is satisfied */
          int __SDL_dummy_symbol_for_linker = 0;
          int SDL_dummy_function(void) { return __SDL_dummy_symbol_for_linker; }
          C

          # Build arch-correct .so using NDK clang if available, else host clang
          if [ -x "$NDK_CLANG" ]; then
            echo "Compiling Android-targeted libSDL.so and libSDL2.so with NDK clang"
            "$NDK_CLANG" -target "$TARGET" -fPIC -shared "$SHIM_C" -o "$found/libSDL.so" || true
            "$NDK_CLANG" -target "$TARGET" -fPIC -shared "$SHIM_C" -o "$found/libSDL2.so" || true
          else
            echo "NDK clang missing — creating host shims (may still satisfy linker in some cases)"
            clang -shared -fPIC "$SHIM_C" -o "$found/libSDL.so" || true
            clang -shared -fPIC "$SHIM_C" -o "$found/libSDL2.so" || true
          fi

          # Ensure file exists and print info
          for f in "$found/libSDL.so" "$found/libSDL2.so"; do
            if [ -f "$f" ]; then
              echo "Created shim: $f"
              file "$f" || true
              ls -l "$f" || true
            else
              echo "Failed to create $f"
            fi
          done

          # Defensive: also populate every libs dir under .buildozer with arch-targeted shim
          find .buildozer -type d -name "libs" -print0 | while IFS= read -r -d '' d; do
            if [ -x "$NDK_CLANG" ]; then
              "$NDK_CLANG" -target "$TARGET" -fPIC -shared "$SHIM_C" -o "$d/libSDL.so" || true
              "$NDK_CLANG" -target "$TARGET" -fPIC -shared "$SHIM_C" -o "$d/libSDL2.so" || true
            else
              clang -shared -fPIC "$SHIM_C" -o "$d/libSDL.so" || true
              clang -shared -fPIC "$SHIM_C" -o "$d/libSDL2.so" || true
            fi
            echo "Ensured shim in $d"
          done || true

          rm -f "$SHIM_C"



      - name: Build APK
        env:
          P4A_ARCH: ${{ matrix.arch }}
        run: |
          echo "Building for arch: $P4A_ARCH"
          buildozer -v android debug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.arch }}
          path: bin/*.apk
          retention-days: 14

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: |
            artifacts/**/*.apk
