name: StalinGame

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [armeabi-v7a, arm64-v8a]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip make build-essential \
            gcc g++ clang binutils \
            openjdk-11-jdk \
            autoconf automake autoconf-archive libtool pkg-config \
            libltdl-dev cmake \
            python3-pip python3-setuptools python3-dev \
            cython3 \
            zlib1g-dev libssl-dev libffi-dev \
            libncurses5-dev libncursesw5-dev libtinfo-dev \
            libbz2-dev libexpat1-dev libreadline-dev libsqlite3-dev \
            libgdbm-dev libgdbm-compat-dev liblzma-dev

      - name: Install Buildozer and pinned Cython
        run: |
          python3 -m pip install --upgrade pip
          pip install --upgrade buildozer
          pip install --upgrade cython==0.29.36

      - name: Clean previous builds (force fresh)
        run: |
          rm -rf ./.buildozer/android/platform/build-* || true
          rm -rf ./.buildozer/android/platform/python-for-android || true
          rm -rf ./.buildozer/android/platform/buildozer || true

      ############################################
      #  local-recipes/pyjnius (safe, via heredoc)
      ############################################
      - name: Create local PyJNIus recipe and patches
        run: |
          mkdir -p local-recipes/pyjnius/patches

          cat << 'PY' > local-recipes/pyjnius/recipe.py
          from pythonforandroid.recipes.pyjnius import PyjniusRecipe as BaseRecipe
          
          class PyjniusFixedRecipe(BaseRecipe):
              def prebuild_arch(self, arch):
                  print(">>> Applying PyJNIus patches...")
                  self.apply_patch("patches/fix_long.patch")
                  self.apply_patch("patches/fix_jsize.patch")
                  super().prebuild_arch(arch)
          
          recipe = PyjniusFixedRecipe()
          PY
          
                    cat << 'PATCH' > local-recipes/pyjnius/patches/fix_long.patch
          *** Begin Patch
          *** Update File: jnius/jnius_utils.pxi
          @@
          -        if r == 'S' or r == 'I':
          -            if isinstance(arg, int) or (
          -                    (isinstance(arg, long) and arg < 2147483648)):
          +        if r == 'S' or r == 'I':
          +            # Python3: no long type
          +            if isinstance(arg, int) and arg < 2147483648:
                           score += 10
                           continue
          *** End Patch
          PATCH
          
                    cat << 'PATCH' > local-recipes/pyjnius/patches/fix_jsize.patch
          *** Begin Patch
          *** Update File: jnius/jnius_conversion.pxi
          @@
          -    j_strlen = len(py_bytes) / sizeof(jchar) - 1
          +    # integer division, converting to jsize
          +    j_strlen = <jsize>(len(py_bytes) // sizeof(jchar) - 1)
          *** End Patch
          PATCH

      ############################################
      #  Trigger p4a download (makes pyjnius sources appear), then patch if needed
      ############################################
      - name: Trigger p4a download and patch PyJNIus if present
        run: |
          set -euxo pipefail
          # Run a lightweight p4a call to make p4a download recipes (may print warnings)
          buildozer android p4a -- --version || true

          # Find any downloaded jnius files and patch them in-place (if present)
          PYJ_FILE=$(find .buildozer -type f -name "jnius_utils.pxi" | head -n1 || true)
          echo "Found jnius_utils.pxi: '${PYJ_FILE:-<none>}'"

          if [ -n "$PYJ_FILE" ]; then
            PYJ_DIR=$(dirname "$PYJ_FILE")
            echo "Patching pyjnius in: $PYJ_DIR"

            cp -v "$PYJ_DIR/jnius_utils.pxi" "$PYJ_DIR/jnius_utils.pxi.bak" || true
            cp -v "$PYJ_DIR/jnius_conversion.pxi" "$PYJ_DIR/jnius_conversion.pxi.bak" || true

            sed -i 's/isinstance(arg, long)/isinstance(arg, int)/g' "$PYJ_DIR/jnius_utils.pxi" || true
            sed -i 's/len(py_bytes) \/ sizeof(jchar) - 1/<int>(len(py_bytes) \/ sizeof(jchar) - 1)/g' "$PYJ_DIR/jnius_conversion.pxi" || true

            echo "Patched (in-place) pyjnius sources:"
            head -n 5 "$PYJ_DIR/jnius_utils.pxi" || true
            head -n 5 "$PYJ_DIR/jnius_conversion.pxi" || true
          else
            echo "PyJNIus sources not yet downloaded — local-recipes will be used when p4a downloads them."
          fi

      ############################################
      #  SDL shim creation (create libSDL.so in any libs dirs and project ./libs)
      ############################################
      - name: Create libSDL.so shim (in libs directories)
        run: |
          set -euxo pipefail
          # create a local libs dir
          mkdir -p ./libs
          # create shim in project libs (fallback)
          echo "" | clang -shared -o ./libs/libSDL.so -x c - || true

          # find any libs directories under .buildozer and place shim there too
          find .buildozer -type d -name "libs" -print0 | while IFS= read -r -d '' d; do
            mkdir -p "$d"
            echo "" | clang -shared -o "$d/libSDL.so" -x c - || true
            echo "Created shim: $d/libSDL.so"
          done || true
      - name: Create Android libSDL.so shim (arch-aware)
        run: |
          set -euxo pipefail

          # Path to NDK clang inside buildozer layout (should exist after p4a has prepared NDK)
          NDK_CLANG="${HOME}/.buildozer/android/platform/android-ndk-r25b/toolchains/llvm/prebuilt/linux-x86_64/bin/clang"

          if [ ! -x "$NDK_CLANG" ]; then
            echo "NDK clang not found at $NDK_CLANG"
            echo "Listing .buildozer contents for debugging:"
            ls -la ./.buildozer || true
          fi

          # Calculate expected sdl2 obj dir that p4a uses (search safe)
          # Prefer exact path printed in logs: build/bootstrap_builds/sdl2/obj/local/<arch>
          SDL_OBJ_DIR=$(find .buildozer -type d -path "*/build/bootstrap_builds/sdl2/obj/local/${P4A_ARCH:-arm64-v8a}" | head -n1 || true)

          # If not found, try generic search for any sdl2 obj local dir
          if [ -z "$SDL_OBJ_DIR" ]; then
            SDL_OBJ_DIR=$(find .buildozer -type d -path "*/build/bootstrap_builds/sdl2/obj/local/*" | head -n1 || true)
          fi

          echo "Detected SDL OBJ dir: ${SDL_OBJ_DIR:-<none>}"

          # Choose target triple depending on arch
          case "${P4A_ARCH:-arm64-v8a}" in
            arm64-v8a)
              TARGET="aarch64-linux-android21"
              ;;
            armeabi-v7a)
              TARGET="armv7a-linux-androideabi21"
              ;;
            *)
              TARGET="aarch64-linux-android21"
              ;;
          esac

          # Create a small c source for the shim
          SHIM_C="/tmp/sdl_shim.c"
          cat > "$SHIM_C" <<'C_CODE'
          /* minimal dummy symbol so linker is satisfied */
          int __SDL_dummy_symbol_for_linker = 0;
          int SDL_dummy_function(void) { return __SDL_dummy_symbol_for_linker; }
          C_CODE

          # If we found SDL obj dir, build proper Android-targeted lib there
          if [ -n "$SDL_OBJ_DIR" ] && [ -x "$NDK_CLANG" ]; then
            mkdir -p "$SDL_OBJ_DIR"
            echo "Compiling libSDL.so for target $TARGET into $SDL_OBJ_DIR"
            # Use NDK clang with target to produce correct target-arch .so
            "$NDK_CLANG" -target "$TARGET" -fPIC -shared "$SHIM_C" -o "$SDL_OBJ_DIR/libSDL.so"
            echo "Created: $SDL_OBJ_DIR/libSDL.so"
            file "$SDL_OBJ_DIR/libSDL.so" || true
          else
            echo "SDL obj dir not found or NDK clang missing — creating fallback ./libs/libSDL.so compiled for host (may still satisfy linker)"
            mkdir -p ./libs
            clang -shared -o ./libs/libSDL.so -x c - <<< 'int SDL_dummy(){return 0;}' || true
            file ./libs/libSDL.so || true
          fi

          # Also create shims in any libs directories found under .buildozer (defensive)
          find .buildozer -type d -name "libs" -print0 | while IFS= read -r -d '' d; do
            mkdir -p "$d"
            if [ -x "$NDK_CLANG" ]; then
              "$NDK_CLANG" -target "$TARGET" -fPIC -shared "$SHIM_C" -o "$d/libSDL.so" || true
            else
              echo "" | clang -shared -o "$d/libSDL.so" -x c - || true
            fi
            echo "Ensured shim: $d/libSDL.so"
          done || true


      - name: Build APK
        env:
          P4A_ARCH: ${{ matrix.arch }}
        run: |
          echo "Building for arch: $P4A_ARCH"
          buildozer -v android debug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.arch }}
          path: bin/*.apk
          retention-days: 14

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: |
            artifacts/**/*.apk
