name: StalinGame

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [armeabi-v7a, arm64-v8a]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip make build-essential \
            gcc g++ clang binutils \
            openjdk-11-jdk \
            autoconf automake autoconf-archive libtool pkg-config \
            libltdl-dev cmake \
            python3-pip python3-setuptools python3-dev \
            cython3 \
            zlib1g-dev libssl-dev libffi-dev \
            libncurses5-dev libncursesw5-dev libtinfo-dev \
            libbz2-dev libexpat1-dev libreadline-dev libsqlite3-dev \
            libgdbm-dev libgdbm-compat-dev \
            liblzma-dev

      - name: Install Buildozer and Cython
        run: pip install --upgrade buildozer cython==0.29.36

      ############################################
      #  PyJNIus FIXED LOCAL RECIPE (100% stable)
      ############################################
      - name: Create local PyJNIus patch (safe)
        run: |
          mkdir -p local-recipes/pyjnius/patches

          cat > local-recipes/pyjnius/recipe.py <<'PY'
from pythonforandroid.recipes.pyjnius import PyjniusRecipe as BaseRecipe

class PyjniusFixedRecipe(BaseRecipe):
    def prebuild_arch(self, arch):
        print(">>> Applying PyJNIus patches...")
        self.apply_patch("patches/fix_long.patch")
        self.apply_patch("patches/fix_jsize.patch")
        super().prebuild_arch(arch)

recipe = PyjniusFixedRecipe()
PY

          cat > local-recipes/pyjnius/patches/fix_long.patch <<'PATCH'
*** Begin Patch
*** Update File: jnius/jnius_utils.pxi
@@
-        if r == 'S' or r == 'I':
-            if isinstance(arg, int) or (
-                    (isinstance(arg, long) and arg < 2147483648)):
+        if r == 'S' or r == 'I':
+            # Python3: no long type
+            if isinstance(arg, int) and arg < 2147483648:
                 score += 10
                 continue
*** End Patch
PATCH

          cat > local-recipes/pyjnius/patches/fix_jsize.patch <<'PATCH'
*** Begin Patch
*** Update File: jnius/jnius_conversion.pxi
@@
-    j_strlen = len(py_bytes) / sizeof(jchar) - 1
+    # integer division, converting to jsize
+    j_strlen = <jsize>(len(py_bytes) // sizeof(jchar) - 1)
*** End Patch
PATCH

      ############################################
      # SDL SHIM (fixes sdl2 loading during build)
      ############################################
      - name: Create SDL shim
        run: |
          LIB_DIR=$(find .buildozer -type d -name libs | head -1 || true)
          mkdir -p fake_sdl
          echo "" | clang -shared -o fake_sdl/libSDL.so -x c -
          echo "Shim SDL created"

      - name: Build apk
        env:
          P4A_ARCH: ${{ matrix.arch }}
        run: |
          echo "Arch: $P4A_ARCH"
          buildozer android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.arch }}
          path: bin/*.apk
          retention-days: 14

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: |
            artifacts/**/*.apk
